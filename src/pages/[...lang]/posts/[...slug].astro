---
import { getEntry } from "astro:content";
import { getCollection } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import GradientTag from "../../../components/GradientTag.astro";
import { defaultLang } from "../../../i18n/ui";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((post) => {
    const { slug } = post;

    return {
      params: {
        lang:
          slug.split("/")[0] === defaultLang ? undefined : slug.split("/")[0],
        slug: slug.split("/")[1],
      },
    };
  });
}

const { lang, slug } = Astro.params;
const post = (await getEntry("posts", `${lang ?? defaultLang}/${slug}`))!;
const category = await getEntry(post.data.category);
const authors = await Promise.all(
  post.data.authors.map((author) => getEntry(author.author)),
);
const { Content, headings } = await post.render();
---

<Layout title={post.data.title}>
  <article class="container mx-auto max-w-screen-lg">
    <header>
      <div class="my-14">
        <div class="text-sm">
          <GradientTag> {category.data.name}</GradientTag>
        </div>
        <h1 class="text-4xl font-bold mb-4">
          {post.data.title}
        </h1>
        <p>{post.data.description}</p>
      </div>
      <img
        src={post.data.image}
        alt={post.data.title}
        class="aspect-[1200/630] mx-0 w-full h-full object-cover rounded-lg overflow-hidden"
      />
    </header>
    <section class="flex justify-between flex-wrap gap-x-96">
      <div>
        <div class="text-sm flex justify-start items-center">
          {authors.map(async (author) => <span>{author.data.name}</span>)}
        </div>
        <div>
          {
            Intl.DateTimeFormat(lang, {
              month: "long",
              day: "numeric",
              year: "numeric",
            }).format(post.data.pubDate)
          }
        </div>
      </div>
      <div>Share</div>
    </section>
    <div class="divider"></div>
    <div class="grid grid-row-2 md:gap-x-12 md:grid-cols-12 lg:grid-cols-10">
      <section class="md:col-span-8 lg:col-span-7 text-lg">
        <Content />
      </section>
      <aside class="md:col-span-4 lg:col-span-3">
        <section>Tags</section>
        <section class="invisible md:visible">TOC</section>
      </aside>
    </div>
  </article>
</Layout>
